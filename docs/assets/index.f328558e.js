function t(t){if(console.assert(null!==t),null===t)throw new Error}const e=document.querySelector("#input-area");t(e);const n=document.querySelector("#output-area");function r(e,n){const r=n.getAttribute("text");t(r);const s=l(r),o=s.querySelectorAll("a");if(1===o.length){const t=o.item(0);if(1===s.childNodes.length)n.setAttribute("type","link"),n.setAttribute("text",t.text),n.setAttribute("url",t.href);else{const r=[...s.childNodes].indexOf(t);if(r===s.childNodes.length-1){s.removeChild(t);const r=i(s).trim();n.setAttribute("text",r),n.setAttribute("html",r);const l=e.createElement("outline");l.setAttribute("type","link"),l.setAttribute("text",t.text),l.setAttribute("url",t.href),n.prepend(l)}else if(0===r){n.setAttribute("type","link"),n.setAttribute("text",t.text),n.setAttribute("url",t.href),s.removeChild(t);const r=i(s).trim(),l=e.createElement("outline");l.setAttribute("text",r),l.setAttribute("html",r),n.prepend(l)}}}else o.length>=2||n.setAttribute("html",r);const u=n.getAttribute("_note");if(null!==u){const t=u.split(/\r?\n/);for(const r of t.reverse()){const t=l(r).querySelectorAll("a"),i=e.createElement("outline");if(1===t.length){const e=t.item(0);i.setAttribute("type","link"),i.setAttribute("text",e.text),i.setAttribute("url",e.href)}else t.length>=2?i.setAttribute("text",r):(i.setAttribute("text",r),i.setAttribute("html",r));n.prepend(i)}n.removeAttribute("_note")}}function l(t){const e=document.createElement("template");return e.innerHTML=t,e.content}function i(t){const e=document.createElement("dummy");return e.append(t),e.innerHTML}t(n),e.addEventListener("input",(()=>{const t=(new DOMParser).parseFromString(e.value,"text/xml");if(t.getElementsByTagName("parsererror").length>0)""!==e.value?n.value="エラー：OPMLとして認識できません。":n.value="";else{for(const e of[...t.getElementsByTagName("outline")])r(t,e);n.value=function(t){const e=(new XMLSerializer).serializeToString(t.documentElement);return e.startsWith("<?xml")?e:'<?xml version="1.0"?>\n'+e}(t),n.focus({preventScroll:!0}),n.setSelectionRange(0,0)}}));
